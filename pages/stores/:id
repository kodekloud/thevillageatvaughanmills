<div id="pop-over">
    <span class="pull-left">
        <p id="pop-over-map-name">Default Name</p>
        <p id="pop-over-map-phone">Phone Number</p>
    </span>
    <span class="pullright"><img alt="arrow" src="https://testbucketblurt.s3-us-west-2.amazonaws.com/sites/54205e6a6a616d39c5860000/04dd4f94364d574f0365c89cbafa12c4/btn_search_arrow.png"></span>
</div>
<div class="main">
     <div class="container">
          <section class="hgroup" id="store_title_container">
            <script id="store_title_template" type="x-tmpl-mustache/text">
               <h1>{{name}}</h1>
               <h2>Level {{z_coordinate}}</h2>
               <ul class="breadcrumb pull-right">
                    <li><a href="/home">Home</a> </li>
                    <li><a href="/stores">Store Directory</a> </li>
                    <li class="active">{{name}}</li>
               </ul>
            </script>
          </section>
          <section>
               <div class="row">
                    <div class="col-sm-8 col-md-8">
                         
                            
                                <div id="zControls">
                                    <button class="zoom-in"><span class="glyphicon glyphicon-plus"></span></button>
                                    <button class="zoom-out"><span class="glyphicon glyphicon-minus"></span></button>
                                    
                                </div>
                                <div id="map" class="panzoom-elements" style=""></div>
                            
                        
                    </div>
                    <div class="col-sm-4 col-md-4">
                        <article class="portfolio_details">
                            <div id="store_detail_container">
                            <script id="store_detail_template" type="x-tmpl-mustache/text">
                               
                              <p style="margin-bottom:0" id="phone_label"><strong>Phone :</strong> {{phone}}</p>
                              <p style="margin-bottom:0" id="email_label"><strong>Email :</strong> {{email}}</p>
                            </script>
                            </div>
                            <p style="margin-bottom:0"><strong>Hours :</strong></p>
                            <div id="store_hours_container">
                                <script id="store_hours_template" type="x-tmpl-mustache/text">
                                    <li style="list-style:none">{{day}}: {{open_time}} / {{close_time}}</li>
                                </script>
                            </div>
                            <br>
                            <div id="store_detail_container2">
                            <script id="store_detail_template2" type="x-tmpl-mustache/text">
                              <p>{{description}}</p>
                              <a style="display:none" id="store_website_link" href="http://{{website}}" target="_blank" class="btn btn-danger center-block btn-lg">Visit Store Site</a> 
                            </script>
                            </div>
                            
                        </article>
                    </div>
               </div>
          </section>
          
          <h2 style="margin-top:60px;display:none" id="promo_header" >Promotions</h2>
          <section class="service_teasers" id="promo_list_container">
            <script id="promo_list_template" type="x-tmpl-mustache/text">
               <div class="service_teaser">
                    <div class="row">
                         <div class="service_photo col-sm-4 col-md-4">
                              <figure style="background-image:url('{{alt_promo_image_url}}')"></figure>
                         </div>
                         <div class="service_details col-sm-8 col-md-8">
                              <h2 class="section_header skincolored"><b>{{name}}</b></h2>
                              <p>{{description}}</p>
                              <a href="../promotions/{{slug}}" class="btn btn-primary pull-right">view detail</a> </div>
                    </div>
               </div>
            </script>
          </section> 
          
          
          <h2 style="margin-top:60px;display:none" id = "job_header" >Careers</h2>
          <section class="service_teasers" id="job_list_container">
            <script id="job_list_template" type="x-tmpl-mustache/text">
               <div class="service_teaser">
                    <div class="row">
                         <div class="service_photo col-sm-4 col-md-4">
                              <figure style="background-image:url('{{image_url}}')"></figure>
                         </div>
                         <div class="service_details col-sm-8 col-md-8">
                              <h2 class="section_header skincolored"><b>{{name}}</b></h2>
                              <p>{{job_type}}</p>
                              <p>{{{rich_description}}}</p>
                    </div>
               </div>
            </script>
          </section> 
          
          
          <!-- <section>
               <ul class="pager">
                    <li class="previous"><a href="portfolio_item.html">← Older</a></li>
                    <li class="next disabled"><a href="#">Newer →</a></li>
               </ul>
          </section> -->
     </div>
</div>

<!--For more information please see http://learnjs.io/blog/2013/11/30/snapsvg-resources/-->
<script src="//cdnjs.cloudflare.com/ajax/libs/snap.svg/0.3.0/snap.svg-min.js"></script>
<script src="http://kodekloud.s3.amazonaws.com/sites/5422419e4a616d74d9030000/e1fb5e17ab727d248230fbcb51da868f/jquery.panzoom.min.js"></script>
 
<script>
    $("#directory_link").addClass("active");
    $(document).ready(function() {
        
        
        function renderPageData(){
            //renders the store list by referencing the template id and the html id
            //for where to place the rendered content. See mallmaverick.js for implementation
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var store_details = getStoreDetailsBySlug(slug);
            // checkErrorPage(store_details);
            var store_promos = getPromotionsForIds(store_details.promotions);
            var jobs = getJobsForIds(store_details.jobs);
            $("#pop-over").hide();
            renderTemplate("#store_title_container","#store_title_template", store_details, "store_details");
            renderTemplate("#store_detail_container","#store_detail_template", store_details, "store_details");
            renderTemplate("#store_hours_container","#store_hours_template", store_details, "hours");
            renderTemplate("#store_detail_container2","#store_detail_template2", store_details, "store_details");
            renderTemplate("#promo_list_container","#promo_list_template", store_promos, "promotions");
            renderTemplate("#job_list_container","#job_list_template", jobs, "jobs");
            renderSVGMap(store_details);
            
        }
        
   
    
    
    
    function renderSVGMap(store_details){
            var isMobile = ( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) );
            var didPanZoom = false;
            if(navigator.appVersion.indexOf("MSIE 9.") == -1){
                $('#map').bind('mousemove', function(e){
                    //console.log(e.pageX+","+e.pageY);
                   $('#pop-over').css({'top':e.pageY+20,'left':e.pageX-70});
                });
                var s = Snap("#map");
                var store_svg_id = null;
                if(store_details.svgmap_region != null && typeof(store_details.svgmap_region)  != 'undefined'){
                    store_svg_id = "#"+ store_details.svgmap_region;
                }
                var stores = getStoresList();
                Snap.load(getSVGMapURL(), function (f) {
                    if(store_svg_id!=null){
                        f.select(store_svg_id).addClass("map-mouse-over");
                        console.log(store_svg_id)
                        
                    }
                    $.each( stores, function( key, value ) {
                        if(value.svgmap_region != null && typeof(value.svgmap_region)  != 'undefined'){
                            var svg_id = "#" + value.svgmap_region;
                            f.select(svg_id).mouseover(function() {
                                if(typeof(value) != 'undefined' && value != null){
                                    this.addClass("map-mouse-over");
                                    $("#pop-over").show();
                                    $("#pop-over-map-name").html(value.name);
                                    $("#pop-over-map-phone").html(value.phone);
                                }
                                          
                            });
                                
                            //add the mouse up handler for hiding the pop over when done hovering
                            
                                f.select(svg_id).mouseout(function() {
                                    if (svg_id != store_svg_id) {
                                        this.removeClass("map-mouse-over");    
                                    }
                                    
                                    $("#pop-over").hide(0);
                                    
                                });
                                    
                            
                            
                            //add the mouse up function for when the user clicks a store
                            f.select(svg_id).mouseup(function() {
                                
                                if(!isMobile && !didPanZoom){
                                    
                                    goToStore(value);
                                }
                                didPanZoom = false;
                                      
                            });
                        }
                    });
                    s.append(f.select("svg"));
                    
                    
                    
                });
                
                var startingMapTransform = 'scale(1.05)';
                var startingPanX = -120;
                var startingPanY = -100;
                if(isMobile) {
                        startingMapTransform = 'scale(0.20)';
                        startingPanX = -170;
                        startingPanY = -200;
                }
                $('#loading').hide();
                $( "#page_content" ).fadeIn( "fast", function() {
                    var panzoom = $(".panzoom-elements").panzoom({
                        cursor: "move",
                        increment: 0.15,
                        minScale: 0.15,
                        maxScale: 20,
                        transition: true,
                        duration: 150,
                        easing: "ease-in-out",
                        $zoomIn: $('.zoom-in'),
                        $zoomOut: $('.zoom-out'),
                        $zoomRange: $('.zoom-range'),
                        startTransform: startingMapTransform
            
                    });
                    $(".panzoom-elements").panzoom("pan", startingPanX, startingPanY, { relative: true });
                    
                    panzoom.on('panzoomchange', function(e, panzoom, matrix, changed) {
                      didPanZoom = true;
                    });
                    
                    panzoom.on('panzoomend', function(e, panzoom, matrix, changed) {
                      didPanZoom = false;
                    });
                });
            }else{
                $('#loading').hide();
                $('#zControls').hide();
                $('#map').hide();
                $( "#page_content" ).fadeIn( "fast");
            }
        }
    function goToStore(store_details){
        if(typeof(store_details) != 'undefined' && store_details != null){
            window.location.href = "/stores/"+store_details.slug;
        }
    }
        
        loadMallData(renderPageData);
        
        function renderTemplate(container, template, collection, type){
            var item_list = [];
            var item_rendered = [];
            var template_html = $(template).html();
            Mustache.parse(template_html);   // optional, speeds up future uses
            if (type == "store_details"){
                item_list.push(collection)
                $.each( item_list , function( key, val ) {
     
                    if (val.phone){
                        $("#phone_label").show();
                    }else {
                        $("#phone_label").hide();
                    }
                    if (val.email){
                        $("#email_label").show();
                    } else {
                         $("#email_label").hide();
                    }
                    val.alt_store_front_url = getImageURL(val.store_front_url); 
                    if (val.gallery){
                        val.alt_gallery_image = getImageURL(val.gallery[0]);    
                    }
                    
                    
                    val.hours = (getHoursForIds(val.store_hours))
                    var rendered = Mustache.render(template_html,val);
                    item_rendered.push(rendered);
                });
            }else if (type == "hours"){
                hours = getHoursForIds(collection.store_hours)
                $.each( hours , function( key, val ) {
                    switch(val.day_of_week) {
                        case 0:
                            val.day = "Sunday"
                            break;
                        case 1:
                            val.day = "Monday"
                            break;
                        case 2:
                            val.day = "Tuesday"
                            break;
                        case 3:
                            val.day = "Wednesday"
                            break;
                        case 4:
                            val.day = "Thursday"
                            break;
                        case 5:
                            val.day = "Friday"
                            break;
                        case 6:
                            val.day = "Saturday"
                            break;
                        
                    }
                    var open_time = new Date (val.open_time)
                    var close_time = new Date (val.close_time)
                    val.open_time = convert_hour(open_time);
                    val.close_time = convert_hour(close_time);
                    var rendered = Mustache.render(template_html,val);
                    item_rendered.push(rendered);
                    
                });
            }else {
                $.each( collection , function( key, val ) {
                    // if (type == "store_details"){
                    //     val.alt_store_front_url = getImageURL(val.store_front_url);    
                    // }
                    if (type == "promotions"){
                        if ((val.promo_image_url).indexOf('missing.png') > -1){
                            var pathArray = window.location.pathname.split( '/' );
                            var slug = pathArray[pathArray.length-1];
                            var store_details = getStoreDetailsBySlug(slug);
                            val.alt_promo_image_url = getImageURL(store_details.store_front_url);
                        } else {
                            val.alt_promo_image_url = getImageURL(val.promo_image_url);
                        }
                        $("#promo_header").show();   
                        
                    }
                    if (type == "jobs") {
                        var pathArray = window.location.pathname.split( '/' );
                        var slug = pathArray[pathArray.length-1];
                        var store_details = getStoreDetailsBySlug(slug);
                        val.image_url = getImageURL(store_details.store_front_url);
                        $("#job_header").show();  
                    }
                    var rendered = Mustache.render(template_html,val);
                    item_rendered.push(rendered);
                    
                    
                });
            }
            
            $(container).show();
            $(container).html(item_rendered.join(''));
            if (type == "store_details"){
                if (collection.website != ""){
                        $("#store_website_link").show();
                }
            }
            
        }
        
        
        
        function convert_hour(d){
            var h = addZero(d.getUTCHours());
            var m = addZero(d.getUTCMinutes());
            var s = addZero(d.getUTCSeconds());
            if (h >= 12) {
                if ( h != 12) {
                    h = h - 12;    
                }
                
                i = "PM"
            } else {
                i = "AM"
            }
            return h+":"+m+" "+i;
        }
        
        
        
        function addZero(i) {
            if (i < 10) {
                i = "0" + i;
            }
            return i;
        }
        


        
        
    });
    
    
</script>
